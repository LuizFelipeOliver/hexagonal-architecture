name: Tests

on:
  pull_request:
    branches: [dev]

permissions:
  checks: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Clonando repositÃ³rio"
        uses: actions/checkout@v4

      - name: "â˜• Configurando Java 25"
        uses: actions/setup-java@v4
        with:
          java-version: "25"
          distribution: "temurin"
          cache: maven

      - name: "ğŸ“¦ Baixando dependÃªncias"
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias do Maven..."
          ./mvnw dependency:resolve --batch-mode -q
          echo "âœ… DependÃªncias instaladas com sucesso!"

      - name: "ğŸ§ª Rodando testes"
        run: |
          echo "ğŸ§ª Iniciando execuÃ§Ã£o dos testes..."
          echo "----------------------------------------"
          ./mvnw test --batch-mode
          echo "----------------------------------------"
          echo "âœ… Todos os testes passaram!"

      - name: "ğŸ“Š Gerando relatÃ³rio de testes"
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: "ğŸ“‹ Resultados dos Testes"
          path: target/surefire-reports/*.xml
          reporter: java-junit

      - name: "ğŸ“ˆ Resumo dos testes"
        if: always()
        run: |
          echo "ğŸ“ˆ Resumo da execuÃ§Ã£o:"
          echo "----------------------------------------"
          if [ -d "target/surefire-reports" ]; then
            TESTS=$(grep -r 'tests=' target/surefire-reports/*.xml | grep -oP 'tests="\K[0-9]+' | paste -sd+ | bc)
            FAILURES=$(grep -r 'failures=' target/surefire-reports/*.xml | grep -oP 'failures="\K[0-9]+' | paste -sd+ | bc)
            ERRORS=$(grep -r 'errors=' target/surefire-reports/*.xml | grep -oP 'errors="\K[0-9]+' | paste -sd+ | bc)
            SKIPPED=$(grep -r 'skipped=' target/surefire-reports/*.xml | grep -oP 'skipped="\K[0-9]+' | paste -sd+ | bc)
            echo "ğŸ§ª Total de testes: $TESTS"
            echo "âœ… Passaram:        $((TESTS - FAILURES - ERRORS - SKIPPED))"
            echo "âŒ Falharam:        $FAILURES"
            echo "ğŸ’¥ Erros:           $ERRORS"
            echo "â­ï¸  Ignorados:      $SKIPPED"
            echo "----------------------------------------"
            if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
              echo "ğŸ‰ Todos os testes passaram com sucesso!"
            else
              echo "âš ï¸  Alguns testes falharam. Verifique o relatÃ³rio acima."
            fi
          else
            echo "âš ï¸  Nenhum relatÃ³rio de teste encontrado."
          fi
